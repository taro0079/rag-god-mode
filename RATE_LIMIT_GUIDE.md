# レート制限エラー対処ガイド

## 問題の概要

Azure OpenAI APIのレート制限エラー（429エラー）が発生した場合の対処方法について説明します。

## 実装された対策

### 1. 自動リトライ機能
- レート制限エラーが発生した場合、指数バックオフで自動的にリトライします
- 最大5回までリトライを試行します
- 待機時間は1秒から開始し、最大60秒まで指数関数的に増加します

### 2. バッチ処理
- 大量のテキストを一度に処理する代わりに、小さなバッチに分割して処理します
- デフォルトのバッチサイズは10チャンクです
- バッチ間には1秒の待機時間を設けています

### 3. プログレス表示
- バッチ処理の進行状況を表示します
- エラーが発生した場合、詳細なエラーメッセージを表示します

## 使用方法

### 環境変数での設定

```bash
# バッチサイズ（デフォルト: 10）
export REDMINE_BATCH_SIZE=5

# バッチ間の待機時間（秒、デフォルト: 1.0）
export REDMINE_BATCH_DELAY=2.0
```

### コマンドライン引数での設定

```bash
# バッチサイズを5に設定
python redmine.py --batch-size 5

# バッチ間の待機時間を2秒に設定
python redmine.py --batch-delay 2.0

# 両方を設定
python redmine.py --batch-size 5 --batch-delay 2.0
```

### 推奨設定

**S0価格ティアの場合:**
```bash
python redmine.py --batch-size 5 --batch-delay 2.0
```

**より高い価格ティアの場合:**
```bash
python redmine.py --batch-size 10 --batch-delay 1.0
```

## エラーメッセージの例

```
レート制限エラーが発生しました。1.0秒待機してリトライします... (試行 1/5)
バッチ 1/10 を処理中... (5 チャンク)
バッチ 1 完了
バッチ 2/10 を処理中... (5 チャンク)
```

## トラブルシューティング

### 1. レート制限が頻繁に発生する場合
- バッチサイズを小さくする（例: `--batch-size 3`）
- バッチ間の待機時間を長くする（例: `--batch-delay 3.0`）

### 2. 処理が遅すぎる場合
- バッチサイズを大きくする（例: `--batch-size 15`）
- バッチ間の待機時間を短くする（例: `--batch-delay 0.5`）

### 3. それでもエラーが発生する場合
- Azure OpenAIの価格ティアを確認し、必要に応じてアップグレードを検討してください
- 処理するデータ量を減らす（例: `--limit 100`で件数を制限）

## 注意事項

- レート制限は時間単位でリセットされます
- 大量のデータを処理する場合は、時間をかけて処理することを推奨します
- エラーが発生した場合は、しばらく時間をおいてから再実行してください
